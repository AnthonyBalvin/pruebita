name: CI/CD Pipeline Completo

on:
  # Se ejecuta cada vez que hacemos push a la rama 'main'
  push:
    branches: [ "main" ]
  # Permite ejecutarlo manualmente desde la interfaz de GitHub
  workflow_dispatch:

# Permisos necesarios para que el workflow pueda subir la imagen de Docker al registro de GitHub
permissions:
  contents: read
  packages: write

jobs:
  build-test-and-push:
    runs-on: ubuntu-latest # Usamos una máquina virtual Linux de GitHub

    steps:
      # 1. Obtener el código del repositorio
      - name: Checkout del código
        uses: actions/checkout@v4

      # 2. Instalar Python en la máquina virtual
      - name: Configurar Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. Instalar las dependencias (pytest, ruff)
      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. CI - Linting (Revisión de estilo)
      # Esto fallará la primera vez por el 'import os' que dejamos en main.py
      - name: Revisar estilo con Ruff (Linting)
        run: ruff check .

      # 5. CI - Ejecutar Tests
      # Le decimos a pytest que busque tests en la carpeta 'tests'
      # y que el código principal está en el directorio actual (.)
      - name: Ejecutar tests con Pytest
        run: pytest tests/
        env:
          PYTHONPATH: .

      # --- Si algún paso anterior falla, el proceso se detiene aquí ---

      # 6. CD - Iniciar sesión en el Registro de Contenedores de GitHub (GHCR)
      - name: Login en GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }} # Tu usuario de GitHub
          password: ${{ secrets.GITHUB_TOKEN }} # Token automático de GitHub

      # 7. CD - Construir y Subir la imagen Docker
      - name: Construir y pushear imagen Docker
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # Nombra la imagen como ghcr.io/TU_USUARIO/TU_REPO:latest
          tags: ghcr.io/${{ github.repository }}:latest